# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: Release

on:
  push:
    branches:
      - main
    paths:
      - 'packages/*/package.json'
      - '.github/workflows/release.yml'
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  pull-requests: write
  id-token: write

jobs:
  checks:
    name: Checks
    if: ${{ github.event_name != 'push' || !contains(github.event.head_commit.message, 'skip ci') }}
    uses: ./.github/workflows/checks.yml
    with:
      upload-coverage: false

  detect:
    name: Detect packages to release
    runs-on: ubuntu-latest
    needs: checks
    outputs:
      has_packages: ${{ steps.changed.outputs.has_packages }}
      packages_json: ${{ steps.changed.outputs.packages_json }}
      packages_md: ${{ steps.changed.outputs.packages_md }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup pnpm + Node.js
        uses: ./.github/actions/setup-pnpm

      - name: Detect version bumps
        id: changed
        shell: bash
        run: |
          set -euo pipefail
          node scripts/release/detect-version-bumps.mjs \
            --mode "${{ github.event_name == 'workflow_dispatch' && 'unpublished' || 'changed' }}" \
            --github-output "${GITHUB_OUTPUT}"

      - name: Write summary
        if: always()
        shell: bash
        run: |
          {
            echo "## Packages to release"
            echo ""
            if [ "${{ steps.changed.outputs.has_packages }}" != "true" ]; then
              echo "- (none)"
            else
              echo "${{ steps.changed.outputs.packages_md }}"
            fi
          } >> "$GITHUB_STEP_SUMMARY"

  publish:
    name: Publish
    runs-on: ubuntu-latest
    needs: detect
    if: needs.detect.outputs.has_packages == 'true'
    strategy:
      fail-fast: false
      matrix:
        pkg: ${{ fromJSON(needs.detect.outputs.packages_json) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup pnpm + Node.js
        uses: ./.github/actions/setup-pnpm
        with:
          registry-url: https://registry.npmjs.org

      - name: Check if version is already published
        id: check_published
        run: |
          set -euo pipefail
          PACKAGE_NAME="${{ matrix.pkg.name }}"
          VERSION="${{ matrix.pkg.version }}"

          # Encode package name for npm registry URL
          if [[ "$PACKAGE_NAME" == @* ]]; then
            ENCODED_NAME="${PACKAGE_NAME/\//%2f}"
          else
            ENCODED_NAME="$PACKAGE_NAME"
          fi

          echo "Checking if $PACKAGE_NAME@$VERSION is already published..."

          # Check npm registry
          RESPONSE=$(npm view "$PACKAGE_NAME@$VERSION" --json 2>/dev/null || echo "{}")

          if echo "$RESPONSE" | grep -q '"name"'; then
            echo "Version $VERSION is already published. Skipping."
            echo "already_published=true" >> "$GITHUB_OUTPUT"
          else
            echo "Version $VERSION is not published yet. Proceeding with release."
            echo "already_published=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Determine previous tag
        id: prev
        if: steps.check_published.outputs.already_published != 'true'
        run: |
          node scripts/gha/determine-prev-tag.mjs \
            --slug "${{ matrix.pkg.slug }}" \
            --current-tag "${{ matrix.pkg.tag }}"

      - name: Build package
        if: steps.check_published.outputs.already_published != 'true'
        shell: bash
        run: |
          set -euo pipefail
          pnpm run gen:flags
          pnpm -r --filter "${{ matrix.pkg.name }}..." run build
        env:
          NODE_ENV: production

      - name: Publish to npm
        if: steps.check_published.outputs.already_published != 'true'
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          echo "Publishing ${{ matrix.pkg.name }}@${{ matrix.pkg.version }} from ${{ matrix.pkg.dir }}"
          (cd "${{ matrix.pkg.dir }}" && npm publish --access public --provenance)

      - name: Generate package changelog
        if: steps.check_published.outputs.already_published != 'true'
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          node scripts/release/generate-package-changelog.mjs \
            --package-dir "${{ matrix.pkg.dir }}" \
            --package-name "${{ matrix.pkg.name }}" \
            --version "${{ matrix.pkg.version }}" \
            --tag "${{ matrix.pkg.tag }}" \
            --prev-tag "${{ steps.prev.outputs.prev_tag }}" \
            --notes-path ".release-notes.md" \
            --github-token "${{ secrets.GITHUB_TOKEN }}" \
            --repo-owner "${{ github.repository_owner }}" \
            --repo-name "${{ github.event.repository.name }}"

      - name: Upload changelog artifact
        if: steps.check_published.outputs.already_published != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: changelog-${{ matrix.pkg.slug }}
          path: ${{ matrix.pkg.dir }}/CHANGELOG.md

      - name: Upload release notes artifact
        if: steps.check_published.outputs.already_published != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: release-notes-${{ matrix.pkg.slug }}
          path: .release-notes.md

      - name: Create and push git tag
        id: tag
        if: steps.check_published.outputs.already_published != 'true'
        run: |
          node scripts/gha/create-and-push-tag.mjs \
            --tag "${{ matrix.pkg.tag }}" \
            --message "${{ matrix.pkg.name }}@${{ matrix.pkg.version }}"

      - name: Create GitHub release
        if: steps.check_published.outputs.already_published != 'true' && steps.tag.outputs.created == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");
            const tag = `${{ matrix.pkg.tag }}`;
            const name = `${{ matrix.pkg.name }}`;
            const version = `${{ matrix.pkg.version }}`;
            const prerelease = version.includes("-");
            const body = fs.readFileSync(".release-notes.md", "utf8");

            core.info(`Creating GitHub release: ${tag} (prerelease=${prerelease})`);

            await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: tag,
              name: `${name}@${version}`,
              body,
              draft: false,
              prerelease,
            });

      - name: Write job summary
        if: always()
        shell: bash
        run: |
          {
            if [ "${{ steps.check_published.outputs.already_published }}" == "true" ]; then
              echo "## Skipped (Already Published)"
              echo ""
              echo "- Package: \`${{ matrix.pkg.name }}@${{ matrix.pkg.version }}\`"
              echo "- Status: This version is already published on npm, skipping release."
            else
              echo "## Published"
              echo ""
              echo "- Package: \`${{ matrix.pkg.name }}@${{ matrix.pkg.version }}\`"
              echo "- Tag: \`${{ matrix.pkg.tag }}\`"
              if [ -f ".release-notes.md" ]; then
                echo ""
                echo "### Release notes"
                echo ""
                cat ".release-notes.md"
              fi
            fi
          } >> "$GITHUB_STEP_SUMMARY"

  changelog:
    name: Commit changelogs
    runs-on: ubuntu-latest
    needs:
      - detect
      - publish
    if: needs.detect.outputs.has_packages == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup pnpm + Node.js
        uses: ./.github/actions/setup-pnpm
        with:
          node-version: 22.x
          pnpm-version: '10'

      - name: Download changelog artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: changelog-*
          merge-multiple: true

      - name: Commit and push changelogs
        run: |
          node scripts/gha/stage-commit-push.mjs \
            --path "packages/*/CHANGELOG.md" \
            --message "docs(changelog): Update package changelogs [skip ci]"

  summary:
    name: Release summary
    runs-on: ubuntu-latest
    needs:
      - detect
      - publish
      - changelog
    if: ${{ always() && needs.detect.result != 'skipped' }}
    steps:
      - name: Write summary
        shell: bash
        run: |
          {
            echo "## Release summary"
            echo ""
            if [ "${{ needs.detect.outputs.has_packages }}" != "true" ]; then
              echo "- (no packages to publish)"
              exit 0
            fi
            echo "### Packages"
            echo ""
            echo "${{ needs.detect.outputs.packages_md }}"
          } >> "$GITHUB_STEP_SUMMARY"
