# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: Release

on:
  push:
    branches:
      - main
    paths:
      - 'packages/*/package.json'
      - '.github/workflows/release.yml'
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  pull-requests: write
  id-token: write

jobs:
  checks:
    name: Checks
    if: ${{ github.event_name != 'push' || !contains(github.event.head_commit.message, 'skip ci') }}
    uses: ./.github/workflows/checks.yml
    with:
      upload-coverage: false

  detect:
    name: Detect packages to release
    runs-on: ubuntu-latest
    needs: checks
    outputs:
      has_packages: ${{ steps.changed.outputs.has_packages }}
      packages_json: ${{ steps.changed.outputs.packages_json }}
      packages_md: ${{ steps.changed.outputs.packages_md }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Detect version bumps
        id: changed
        shell: bash
        run: |
          set -euo pipefail
          node scripts/release/detect-version-bumps.mjs --github-output "${GITHUB_OUTPUT}"

      - name: Write summary
        if: always()
        shell: bash
        run: |
          {
            echo "## Packages to release"
            echo ""
            if [ "${{ steps.changed.outputs.has_packages }}" != "true" ]; then
              echo "- (none)"
            else
              echo "${{ steps.changed.outputs.packages_md }}"
            fi
          } >> "$GITHUB_STEP_SUMMARY"

  publish:
    name: Publish
    runs-on: ubuntu-latest
    needs: detect
    if: needs.detect.outputs.has_packages == 'true'
    strategy:
      fail-fast: false
      matrix:
        pkg: ${{ fromJSON(needs.detect.outputs.packages_json) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Determine previous tag
        id: prev
        shell: bash
        run: |
          set -euo pipefail
          slug="${{ matrix.pkg.slug }}"
          current_tag="${{ matrix.pkg.tag }}"

          prev_tag="$(git tag --list "${slug}-v*" --sort=-v:refname | grep -v "^${current_tag}$" | head -n 1 || true)"
          echo "prev_tag=${prev_tag}" >> "${GITHUB_OUTPUT}"

      - name: Setup pnpm + Node.js
        uses: ./.github/actions/setup-pnpm
        with:
          node-version: 22.x
          pnpm-version: '10'
          registry-url: 'https://registry.npmjs.org'

      - name: Build package
        shell: bash
        run: |
          set -euo pipefail
          pnpm run gen:flags
          pnpm -r --filter "${{ matrix.pkg.name }}..." run build
        env:
          NODE_ENV: production

      - name: Publish to npm
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          echo "Publishing ${{ matrix.pkg.name }}@${{ matrix.pkg.version }} from ${{ matrix.pkg.dir }}"
          (cd "${{ matrix.pkg.dir }}" && npm publish --access public --provenance)

      - name: Generate package changelog
        shell: bash
        run: |
          set -euo pipefail
          node scripts/release/generate-package-changelog.mjs \
            --package-dir "${{ matrix.pkg.dir }}" \
            --package-name "${{ matrix.pkg.name }}" \
            --version "${{ matrix.pkg.version }}" \
            --tag "${{ matrix.pkg.tag }}" \
            --prev-tag "${{ steps.prev.outputs.prev_tag }}" \
            --notes-path ".release-notes.md"

      - name: Upload changelog artifact
        uses: actions/upload-artifact@v4
        with:
          name: changelog-${{ matrix.pkg.slug }}
          path: ${{ matrix.pkg.dir }}/CHANGELOG.md

      - name: Upload release notes artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-notes-${{ matrix.pkg.slug }}
          path: .release-notes.md

      - name: Create and push git tag
        id: tag
        shell: bash
        run: |
          set -euo pipefail

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          tag="${{ matrix.pkg.tag }}"
          if git rev-parse "${tag}" >/dev/null 2>&1; then
            echo "Tag already exists: ${tag}"
            echo "created=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          git tag -a "${tag}" -m "${{ matrix.pkg.name }}@${{ matrix.pkg.version }}"
          git push origin "${tag}"
          echo "created=true" >> "$GITHUB_OUTPUT"

      - name: Create GitHub release
        if: steps.tag.outputs.created == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");
            const tag = `${{ matrix.pkg.tag }}`;
            const name = `${{ matrix.pkg.name }}`;
            const version = `${{ matrix.pkg.version }}`;
            const prerelease = version.includes("-");
            const body = fs.readFileSync(".release-notes.md", "utf8");

            core.info(`Creating GitHub release: ${tag} (prerelease=${prerelease})`);

            await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: tag,
              name: `${name}@${version}`,
              body,
              draft: false,
              prerelease,
            });

      - name: Write job summary
        if: always()
        shell: bash
        run: |
          {
            echo "## Published"
            echo ""
            echo "- Package: \`${{ matrix.pkg.name }}@${{ matrix.pkg.version }}\`"
            echo "- Tag: \`${{ matrix.pkg.tag }}\`"
            if [ -f ".release-notes.md" ]; then
              echo ""
              echo "### Release notes"
              echo ""
              cat ".release-notes.md"
            fi
          } >> "$GITHUB_STEP_SUMMARY"

  changelog:
    name: Commit changelogs
    runs-on: ubuntu-latest
    needs:
      - detect
      - publish
    if: needs.detect.outputs.has_packages == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download changelog artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: changelog-*
          merge-multiple: true

      - name: Commit and push changelogs
        shell: bash
        run: |
          set -euo pipefail

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add packages/*/CHANGELOG.md || true
          if git diff --staged --quiet; then
            echo "No changelog changes to commit."
            exit 0
          fi

          git commit -m "docs(changelog): update package changelogs [skip ci]"
          git push

  summary:
    name: Release summary
    runs-on: ubuntu-latest
    needs:
      - detect
      - publish
      - changelog
    if: ${{ always() && needs.detect.result != 'skipped' }}
    steps:
      - name: Write summary
        shell: bash
        run: |
          {
            echo "## Release summary"
            echo ""
            if [ "${{ needs.detect.outputs.has_packages }}" != "true" ]; then
              echo "- (no packages to publish)"
              exit 0
            fi
            echo "### Packages"
            echo ""
            echo "${{ needs.detect.outputs.packages_md }}"
          } >> "$GITHUB_STEP_SUMMARY"
