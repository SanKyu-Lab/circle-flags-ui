# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: Release

on:
  push:
    branches:
      - main
    paths:
      - 'packages/*/package.json'
      - '.github/workflows/release.yml'
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  pull-requests: write
  id-token: write

jobs:
  checks:
    name: Checks
    if: ${{ github.event_name != 'push' || !contains(github.event.head_commit.message, 'skip ci') }}
    uses: ./.github/workflows/checks.yml
    with:
      upload-coverage: false

  detect:
    name: Detect packages to release
    runs-on: ubuntu-latest
    needs: checks
    outputs:
      has_packages: ${{ steps.changed.outputs.has_packages }}
      packages_json: ${{ steps.changed.outputs.packages_json }}
      packages_md: ${{ steps.changed.outputs.packages_md }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Detect version bumps
        id: changed
        shell: bash
        run: |
          set -euo pipefail

          BEFORE="${{ github.event.before }}"
          AFTER="${{ github.sha }}"

          # workflow_dispatch doesn't have a meaningful "before"
          if [ -z "${BEFORE}" ] || [ "${BEFORE}" = "0000000000000000000000000000000000000000" ]; then
            BEFORE="$(git rev-list --max-parents=0 HEAD)"
          fi

          files="$(git diff --name-only "${BEFORE}" "${AFTER}" -- 'packages/*/package.json' || true)"
          packages=()

          while IFS= read -r file; do
            [ -z "${file}" ] && continue

            if ! git diff "${BEFORE}" "${AFTER}" --unified=0 -- "${file}" | grep -E '^[+-].*\"version\"' >/dev/null; then
              continue
            fi

            isPrivate="$(node -p "Boolean(require('./${file}').private)")"
            if [ "${isPrivate}" = "true" ]; then
              echo "Skip private package: ${file}"
              continue
            fi

            dir="$(dirname "${file}")"
            name="$(node -p "require('./${file}').name")"
            version="$(node -p "require('./${file}').version")"
            slug="$(basename "${dir}")"

            packages+=("${dir}|${name}|${version}|${slug}")
          done <<< "${files}"

          if [ "${#packages[@]}" -eq 0 ]; then
            echo "has_packages=false" >> "${GITHUB_OUTPUT}"
            echo "packages_json=[]" >> "${GITHUB_OUTPUT}"
            echo "packages_md=" >> "${GITHUB_OUTPUT}"
            exit 0
          fi

          packages_json="$(printf "%s\n" "${packages[@]}" | node -e 'const fs=require("fs"); const input=fs.readFileSync(0,"utf8").trim(); const lines=input?input.split("\n").filter(Boolean):[]; const pkgs=lines.map(line=>{const [dir,name,version,slug]=line.split("|"); return {dir,name,version,slug,tag: slug+"-v"+version};}); process.stdout.write(JSON.stringify(pkgs));')"
          packages_md="$(printf "%s\n" "${packages[@]}" | node -e 'const fs=require("fs"); const input=fs.readFileSync(0,"utf8").trim(); const lines=input?input.split("\n").filter(Boolean):[]; const md=lines.map(line=>{const [_dir,name,version,slug]=line.split("|"); return "- `"+name+"@"+version+"` â†’ `"+slug+"-v"+version+"`";}).join("\n"); process.stdout.write(md);')"

          {
            echo "has_packages=true"
            echo "packages_json=${packages_json}"
            echo "packages_md<<EOF"
            echo "${packages_md}"
            echo "EOF"
          } >> "${GITHUB_OUTPUT}"

      - name: Write summary
        if: always()
        shell: bash
        run: |
          {
            echo "## Packages to release"
            echo ""
            if [ "${{ steps.changed.outputs.has_packages }}" != "true" ]; then
              echo "- (none)"
            else
              echo "${{ steps.changed.outputs.packages_md }}"
            fi
          } >> "$GITHUB_STEP_SUMMARY"

  publish:
    name: Publish ${{ matrix.pkg.name }}@${{ matrix.pkg.version }}
    runs-on: ubuntu-latest
    needs: detect
    if: needs.detect.outputs.has_packages == 'true'
    strategy:
      fail-fast: false
      matrix:
        pkg: ${{ fromJSON(needs.detect.outputs.packages_json) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup pnpm + Node.js
        uses: ./.github/actions/setup-pnpm
        with:
          node-version: 22.x
          pnpm-version: '10'
          registry-url: 'https://registry.npmjs.org'

      - name: Build package
        shell: bash
        run: |
          set -euo pipefail
          pnpm run gen:flags
          pnpm -r --filter "${{ matrix.pkg.name }}..." run build
        env:
          NODE_ENV: production

      - name: Publish to npm
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          echo "Publishing ${{ matrix.pkg.name }}@${{ matrix.pkg.version }} from ${{ matrix.pkg.dir }}"
          (cd "${{ matrix.pkg.dir }}" && npm publish --access public --provenance)

      - name: Create and push git tag
        id: tag
        shell: bash
        run: |
          set -euo pipefail

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          tag="${{ matrix.pkg.tag }}"
          if git rev-parse "${tag}" >/dev/null 2>&1; then
            echo "Tag already exists: ${tag}"
            echo "created=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          git tag -a "${tag}" -m "${{ matrix.pkg.name }}@${{ matrix.pkg.version }}"
          git push origin "${tag}"
          echo "created=true" >> "$GITHUB_OUTPUT"

      - name: Create GitHub release
        if: steps.tag.outputs.created == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const tag = `${{ matrix.pkg.tag }}`;
            const name = `${{ matrix.pkg.name }}`;
            const version = `${{ matrix.pkg.version }}`;
            const prerelease = version.includes("-");

            core.info(`Creating GitHub release: ${tag} (prerelease=${prerelease})`);

            await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: tag,
              name: `${name}@${version}`,
              body: `Published \`${name}@${version}\`.`,
              draft: false,
              prerelease,
            });

      - name: Write job summary
        if: always()
        shell: bash
        run: |
          {
            echo "## Published"
            echo ""
            echo "- Package: \`${{ matrix.pkg.name }}@${{ matrix.pkg.version }}\`"
            echo "- Tag: \`${{ matrix.pkg.tag }}\`"
          } >> "$GITHUB_STEP_SUMMARY"

  summary:
    name: Release summary
    runs-on: ubuntu-latest
    needs:
      - detect
      - publish
    if: ${{ always() && needs.detect.result != 'skipped' }}
    steps:
      - name: Write summary
        shell: bash
        run: |
          {
            echo "## Release summary"
            echo ""
            if [ "${{ needs.detect.outputs.has_packages }}" != "true" ]; then
              echo "- (no packages to publish)"
              exit 0
            fi
            echo "### Packages"
            echo ""
            echo "${{ needs.detect.outputs.packages_md }}"
          } >> "$GITHUB_STEP_SUMMARY"
